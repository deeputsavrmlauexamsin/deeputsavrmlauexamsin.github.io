<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Update User — Deeputsav</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; background:#f5f6fb; font-family: Arial, sans-serif; }
    .card { max-width:900px; margin:20px auto; }
    .hidden { display:none !important; }
    .center { text-align:center; }
    .small-note { font-size:0.9rem; color:#666; }
    .progress-bar { height:1rem; }
  </style>
</head>
<body>
  <div class="card shadow">
    <div class="card-body">
      <h3 class="card-title center">Update / Create User</h3>
      <p class="center small-note">You will need your GitHub Personal Access Token (kept in your browser only) and the PIN to unlock the form.</p>

      <!-- PIN lock -->
      <div id="pin-screen" class="mb-3">
        <label class="form-label">Enter PIN to unlock</label>
        <div class="input-group mb-3">
          <input type="password" id="pin-input" class="form-control" placeholder="Enter PIN">
          <button class="btn btn-primary" id="unlock-btn">Unlock</button>
        </div>
        <div class="mb-2 small-note">(Client-side PIN only; change it in the script below if you want another.)</div>
      </div>

      <!-- form -->
      <div id="main-form" class="hidden">
        <div class="mb-3">
          <label class="form-label">GitHub Token</label>
          <input type="password" id="gh-token" class="form-control" placeholder="Paste your GitHub token (will not be saved)">
          <div class="small-note">Token is used in your browser to update the repo. Use a token with minimal scopes.</div>
        </div>

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Name (English)</label>
            <input id="name-en" class="form-control" placeholder="e.g. Aadesh Tiwari">
          </div>
          <div class="col-md-6">
            <label class="form-label">Mobile</label>
            <input id="mobile" class="form-control" placeholder="e.g. 9696511083">
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            <label class="form-label">Card Number (e.g. G07-03923)</label>
            <input id="card-no" class="form-control" placeholder="G07-03923">
          </div>
          <div class="col-md-4">
            <label class="form-label">Ghat Number (just number)</label>
            <input id="ghat-no" class="form-control" placeholder="7">
          </div>
          <div class="col-md-4">
            <label class="form-label">Role (English)</label>
            <input id="role-en" class="form-control" placeholder="e.g. Volunteer">
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-8">
            <label class="form-label">College (English)</label>
            <input id="college-en" class="form-control" placeholder="e.g. Ka.Su Saket P.G. College Ayodhya">
          </div>
          <div class="col-md-4">
            <label class="form-label">Upload Photo</label>
            <input id="photo-input" type="file" accept="image/*" class="form-control">
          </div>
        </div>

        <div class="mt-3">
          <button id="submit-btn" class="btn btn-success">Generate & Upload</button>
          <button id="preview-btn" class="btn btn-outline-primary">Preview Card (local)</button>
        </div>

        <hr>

        <div id="status" class="mt-2"></div>

        <div id="result-area" class="mt-3 hidden">
          <h5>Done</h5>
          <p>Card link: <a id="card-link" target="_blank" rel="noopener"></a></p>
          <p>QR (scan to open card):</p>
          <img id="result-qr" src="" alt="qr" style="max-width:200px; border:1px solid #ddd; padding:6px;">
          <p class="small-note mt-2">If any step fails, check the browser console for details.</p>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  update_user/index.html
  - PIN protected
  - Uses GitHub REST API to create/update:
      Department/Print_Data/photos/{file}
      Department/Print_Data/qr_codes/{file}
      Department/Print_Data/data.csv
  - Generates random 6-char Base64-like slug
  - Uses libretranslate to translate selected fields to Hindi
  - Uses qrserver.com to get QR image then uploads it to repo
*/

/* ==================== CONFIG ==================== */
// change this PIN to something else if you want
const PAGE_PIN = "7410";

/* GitHub repo config (change only if your repo name differs) */
const REPO_OWNER = "deeputsavrmlauexamsin";
const REPO_NAME = "deeputsavrmlauexamsin.github.io";
const CSV_PATH = "Department/Print_Data/data.csv";
const PHOTOS_DIR = "Department/Print_Data/photos/";
const QRS_DIR = "Department/Print_Data/qr_codes/";
const BASE_CARD_URL = "https://deeputsavrmlauexamsin.github.io/Department/Print_Data/?ID=";

/* translate endpoint (public libretranslate instance) */
const TRANSLATE_URL = "https://libretranslate.de/translate";

/* helper - get element */
const $ = id => document.getElementById(id);

/* show status */
function setStatus(html) { $("status").innerHTML = html; }

/* ==================== PIN UNLOCK ==================== */
$("unlock-btn").addEventListener("click", () => {
  const p = $("pin-input").value;
  if (p === PAGE_PIN) {
    $("pin-screen").classList.add("hidden");
    $("main-form").classList.remove("hidden");
  } else {
    alert("Wrong PIN");
  }
});

/* ==================== UTILS ==================== */
function randomSlugBase64(len = 6) {
  // random bytes then btoa; then take len chars
  const arr = new Uint8Array(4);
  window.crypto.getRandomValues(arr);
  let s = "";
  for (let b of arr) s += String.fromCharCode(b);
  let b64 = btoa(s).replace(/=+$/, "");
  return b64.slice(0, len);
}

// Convert file to base64 string
function fileToBase64(file) {
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result.split(",")[1]); // return only base64 part
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

// Fetch file (GET) from GitHub raw (we will use repo raw via pages so simpler)
async function fetchCSVRaw() {
  // GitHub Pages serves the CSV at the site root path:
  const rawUrl = `https://${REPO_OWNER}.github.io/${CSV_PATH}`;
  const r = await fetch(rawUrl + "?_=" + Date.now());
  if (!r.ok) return null;
  return await r.text();
}

// parse TSV (tab) or csv with header
function parseTSV(txt) {
  if (!txt) return [];
  const lines = txt.trim().split(/\r?\n/);
  if (lines.length === 0) return [];
  const header = lines[0].split("\t").map(h => h.trim());
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split("\t");
    const obj = {};
    for (let j = 0; j < header.length; j++) {
      obj[header[j]] = (cols[j] || "").trim();
    }
    rows.push(obj);
  }
  return rows;
}

// create TSV from rows+fieldnames
function makeTSV(rows, fields) {
  let out = fields.join("\t") + "\n";
  for (const r of rows) {
    out += fields.map(f => (r[f] || "")).join("\t") + "\n";
  }
  return out;
}

// github API - get file (to get sha for update)
async function ghGetFile(path, token) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, { headers: { Authorization: "token " + token }});
  if (r.status === 404) return null;
  if (!r.ok) throw new Error("GitHub GET file failed: " + r.status + " " + await r.text());
  return await r.json();
}

// github API - create or update file
async function ghCreateOrUpdate(path, base64content, message, token) {
  const existing = await ghGetFile(path, token);
  const body = {
    message,
    content: base64content,
    branch: "main"
  };
  if (existing && existing.sha) body.sha = existing.sha;
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, {
    method: existing ? "PUT" : "PUT", // PUT both for create/update per API
    headers: {
      Authorization: "token " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });
  if (!r.ok) {
    const txt = await r.text();
    throw new Error("GitHub create/update failed: " + r.status + " " + txt);
  }
  return await r.json();
}

/* translate text to Hindi (via libretranslate) */
async function translateToHindi(text) {
  try {
    const resp = await fetch(TRANSLATE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ q: text, source: "en", target: "hi", format: "text" })
    });
    if (!resp.ok) throw new Error("Translate error");
    const j = await resp.json();
    return j?.translatedText || text;
  } catch (e) {
    console.warn("Translate failed:", e);
    return text; // fallback
  }
}

/* create QR via public API (returns data URL) */
async function createQRDataURL(link, size=400) {
  // using goqr or qrserver public API
  const url = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(link)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error("QR generation failed");
  const blob = await r.blob();
  return await new Promise((res) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.readAsDataURL(blob);
  });
}

/* ==================== MAIN ACTION ==================== */
$("submit-btn").addEventListener("click", async () => {
  try {
    const token = $("gh-token").value.trim();
    if (!token) return alert("Paste your GitHub token first.");

    setStatus("Preparing data...");

    // inputs
    const nameEn = $("name-en").value.trim();
    const mobile = $("mobile").value.trim();
    const cardNo = $("card-no").value.trim() || ("CARD-" + Date.now());
    const ghatNo = $("ghat-no").value.trim();
    const roleEn = $("role-en").value.trim();
    const collegeEn = $("college-en").value.trim();

    if (!nameEn || !mobile) return alert("Enter name and mobile at minimum.");

    // translations (only fields that appear on card in Hindi)
    setStatus("Translating text to Hindi...");
    const nameHi = await translateToHindi(nameEn);
    const roleHi = await translateToHindi(roleEn);
    const collegeHi = await translateToHindi(collegeEn);
    const ghatTextEn = `राम की पैड़ी घाट नं : ${ghatNo || ""}`;
    const ghatHi = await translateToHindi(ghatTextEn);

    // Construct CSV row fields
    // id will be sequential if CSV exists; we will use slug as base64 random
    setStatus("Fetching existing CSV...");
    let rows = [];
    let fields = ["id","slug","name","phone","ghat","role","photo","college"];
    const rawCsv = await fetchCSVRaw();
    if (rawCsv) {
      rows = parseTSV(rawCsv);
    } else {
      rows = [];
    }
    // new id = numeric max + 1 or 1
    let nextId = 1;
    if (rows.length) {
      const max = rows.reduce((m, r) => Math.max(m, parseInt(r.id || 0)), 0);
      nextId = max + 1;
    }
    const idStr = String(nextId);
    const slug = randomSlugBase64(6);

    // handle uploaded photo
    const photoInput = $("photo-input");
    let photoFilename = "";
    if (photoInput.files.length > 0) {
      const f = photoInput.files[0];
      photoFilename = `${idStr}_${f.name.replace(/\s+/g,'_')}`;
      setStatus("Reading photo file...");
      const photoB64 = await fileToBase64(f);
      // upload to repo
      setStatus("Uploading photo to GitHub...");
      await ghCreateOrUpdate(PHOTOS_DIR + photoFilename, photoB64, `Add photo ${photoFilename}`, token);
    } else {
      // no photo uploaded - optional
      photoFilename = "";
    }

    // create QR pointing to card
    const cardLink = BASE_CARD_URL + slug;
    setStatus("Generating QR code...");
    const qrDataURL = await createQRDataURL(cardLink, 400);
    // convert dataURL -> base64 content (strip prefix)
    const qrB64 = qrDataURL.split(",")[1];
    const qrName = `${idStr}_QR.png`;
    setStatus("Uploading QR to GitHub...");
    await ghCreateOrUpdate(QRS_DIR + qrName, qrB64, `Add QR ${qrName}`, token);

    // append row to rows and push CSV
    const newRow = {
      id: idStr,
      slug: slug,
      name: nameHi,
      phone: mobile,
      ghat: ghatHi,
      role: roleHi,
      photo: photoFilename,
      college: collegeHi
    };
    rows.push(newRow);
    const tsv = makeTSV(rows, fields);
    setStatus("Updating data.csv on GitHub...");
    const csvB64 = btoa(unescape(encodeURIComponent(tsv))); // UTF-8 safe
    await ghCreateOrUpdate(CSV_PATH, csvB64, `Update data.csv add ${idStr}`, token);

    // done
    setStatus("All uploaded. Preparing result...");
    $("card-link").href = cardLink;
    $("card-link").textContent = cardLink;
    $("result-qr").src = qrDataURL;
    $("result-area").classList.remove("hidden");
    setStatus("Done — card is live. Scan QR to open the user card.");

  } catch (err) {
    console.error(err);
    setStatus("Error: " + (err.message || err));
    alert("Error: " + (err.message || err));
  }
});

/* Preview button shows a quick local preview by opening the card URL (non-live) */
$("preview-btn").addEventListener("click", () => {
  const slug = randomSlugBase64(6);
  const tmpLink = BASE_CARD_URL + slug;
  window.open(tmpLink, "_blank");
});

</script>
</body>
</html>
