<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Update User — Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fb; padding:20px; }
    .card { max-width:900px; margin:20px auto; }
    .hidden { display:none !important; }
    .center { text-align:center; }
    .small-note { font-size:0.9rem; color:#666; }
  </style>
</head>
<body>
  <div class="card shadow">
    <div class="card-body">
      <h3 class="card-title center">Update / Create User (Admin)</h3>
      <p class="center small-note">PIN protected. Token is stored only in your browser (optional). Do not paste token on a public computer.</p>

      <!-- PIN screen -->
      <div id="pin-screen">
        <label class="form-label">Enter PIN to unlock</label>
        <div class="input-group mb-3">
          <input type="password" id="pin-input" class="form-control" placeholder="Enter PIN">
          <button class="btn btn-primary" id="unlock-btn">Unlock</button>
        </div>
        <div class="small-note">Client-side PIN (not bulletproof) — change it in the file if you want a different PIN.</div>
      </div>

      <!-- main form -->
      <div id="main-form" class="hidden">
        <div class="mb-3">
          <label class="form-label">GitHub Token (paste once; you may choose to save it in this browser)</label>
          <div class="input-group mb-2">
            <input type="password" id="gh-token" class="form-control" placeholder="Paste GitHub token (starts ghp_...)" />
            <button class="btn btn-outline-secondary" id="save-token-btn">Save to browser</button>
            <button class="btn btn-outline-danger" id="clear-token-btn">Clear saved token</button>
          </div>
          <div class="small-note">Token is used only in your browser to call GitHub and will not be sent anywhere else.</div>
        </div>

        <form id="user-form">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Name / नाम</label>
              <input id="name-en" class="form-control" placeholder="e.g. Aadesh Tiwari" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Mobile / मोबाइल नंबर</label>
              <input id="mobile" class="form-control" placeholder="e.g. 9696511083" required>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-4">
              <label class="form-label">Card Number / क्र. (e.g. G07-03923)</label>
              <input id="card-no" class="form-control" placeholder="G07-03923" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ghat No / घाट संख्या (just number)</label>
              <input id="ghat-no" class="form-control" placeholder="7" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Role / दायित्व (English)</label>
              <input id="role-en" class="form-control" placeholder="Volunteer" required>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-8">
              <label class="form-label">College / कॉलेज (English)</label>
              <input id="college-en" class="form-control" placeholder="Ka.Su Saket P.G. College Ayodhya" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Upload Photo / फ़ोटो अपलोड करें</label>
              <input id="photo-input" type="file" accept="image/*" class="form-control" required>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button type="submit" id="submit-btn" class="btn btn-success">Generate & Upload</button>
            <button type="button" id="preview-btn" class="btn btn-outline-primary">Preview Card (open temporary)</button>
          </div>
        </form>

        <hr>
        <div id="status" class="small-note"></div>

        <div id="result-area" class="mt-3 hidden">
          <h5>Done</h5>
          <p>Card link: <a id="card-link" target="_blank" rel="noopener"></a></p>
          <p>QR (scan to open card):</p>
          <img id="result-qr" src="" alt="qr" style="max-width:200px; border:1px solid #ddd; padding:6px;">
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const PAGE_PIN = "9020";
  const REPO_OWNER = "deeputsavrmlauexamsin";
  const REPO_NAME = "deeputsavrmlauexamsin.github.io";
  const DISPATCH_EVENT = "update_user";
  const BASE_CARD_URL = `https://${REPO_OWNER}.github.io/Department/Print_Data/?ID=`;

  const $ = id => document.getElementById(id);
  const setStatus = html => $("status").innerHTML = html;

  // --- unlock logic ---
  $("unlock-btn").addEventListener("click", () => {
    const pin = $("pin-input").value.trim();
    if (pin === PAGE_PIN) {
      $("pin-screen").classList.add("hidden");
      $("main-form").classList.remove("hidden");
      const saved = localStorage.getItem("gh_token_admin");
      if (saved) $("gh-token").value = saved;
    } else {
      alert("❌ गलत PIN / Wrong PIN");
    }
  });

  // --- token save/clear ---
  $("save-token-btn").addEventListener("click", () => {
    const t = $("gh-token").value.trim();
    if (!t) return alert("Paste token first");
    localStorage.setItem("gh_token_admin", t);
    alert("Token saved in this browser.");
  });

  $("clear-token-btn").addEventListener("click", () => {
    localStorage.removeItem("gh_token_admin");
    $("gh-token").value = "";
    alert("Saved token cleared.");
  });

  // --- file helper ---
  function fileToDataURL(file) {
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.onerror = () => rej("File read error");
      fr.readAsDataURL(file);
    });
  }

  function randomSlugBase64(len=6) {
    const arr = new Uint8Array(6);
    window.crypto.getRandomValues(arr);
    let s = "";
    arr.forEach(b => s += String.fromCharCode(b % 255));
    let b64 = btoa(s).replace(/=+$/, "");
    return b64.slice(0, len);
  }

  async function createQRDataURL(link, size=400) {
    const url = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(link)}`;
    const r = await fetch(url);
    const blob = await r.blob();
    return await new Promise(res => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.readAsDataURL(blob);
    });
  }

  async function sendRepositoryDispatch(token, payload) {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`;
    const body = { event_type: DISPATCH_EVENT, client_payload: payload };
    const r = await fetch(url, {
      method: "POST",
      headers: {
        "Accept": "application/vnd.github.v3+json",
        "Authorization": "token " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error("Dispatch failed " + r.status);
    return true;
  }

  // --- submit form ---
  $("user-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      setStatus("Preparing data...");
      let token = $("gh-token").value.trim() || localStorage.getItem("gh_token_admin");
      if (!token) return alert("Please paste your GitHub token first!");

      const nameEn = $("name-en").value.trim();
      const mobile = $("mobile").value.trim();
      const cardNo = $("card-no").value.trim();
      const ghatNo = $("ghat-no").value.trim();
      const roleEn = $("role-en").value.trim();
      const collegeEn = $("college-en").value.trim();
      const photoFile = $("photo-input").files[0];
      if (!photoFile) return alert("Please select a photo.");

      const photoDataURL = await fileToDataURL(photoFile);
      const slug = randomSlugBase64(6);
      const cardLink = BASE_CARD_URL + slug;
      const qrDataURL = await createQRDataURL(cardLink);

      const payload = {
        name: nameEn,
        phone: mobile,
        card_number: cardNo,
        ghat: ghatNo,
        role: roleEn,
        college: collegeEn,
        photo_data_url: photoDataURL,
        qr_data_url: qrDataURL,
        slug
      };

      setStatus("Sending to GitHub...");
      await sendRepositoryDispatch(token, payload);

      $("result-area").classList.remove("hidden");
      $("card-link").href = cardLink;
      $("card-link").textContent = cardLink;
      $("result-qr").src = qrDataURL;
      setStatus("✅ Sent! Wait ~30s for Action to finish.");

    } catch (err) {
      console.error(err);
      alert("Error: " + err.message);
      setStatus("Error: " + err.message);
    }
  });
});
</script>
